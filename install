#!/bin/bash

################################################################################
#
# This script will setup a local copy of the capacity4more distribution.
#
# Do not change the content of this file, 
# all configuration variables are in the config.sh file.
#
################################################################################


# Define the root of the GIT repository
cd ${0%/*}
ROOT=$(git rev-parse --show-toplevel)
cd $ROOT

# Load the colors
source $ROOT/scripts/helper-colors.sh

# Load the helpers
source $ROOT/scripts/helper-functions.sh

# Load the configuration
load_config_file



# Always ask confirmation before destroying the Database & Files!
echo 
echo -e  "${BGBLUE}                                                                 ${RESTORE}"
echo -e "${BGLBLUE}  Install capacity4more                                          ${RESTORE}"
echo -e  "${BGBLUE}                                                                 ${RESTORE}"
echo -e  "${BGBLUE}  > This will delete the database, contrib code and files.       ${RESTORE}"
echo -e  "${BGBLUE}  > This will recreate the environment                           ${RESTORE}"
echo -e  "${BGBLUE}      (download Drupal + contrib modules & themes).              ${RESTORE}"
echo -e  "${BGBLUE}  > This will install the capacity4more profile.                 ${RESTORE}"
echo -e  "${BGBLUE}                                                                 ${RESTORE}"
echo

echo -e -n "${LRED}Are you sure?${RESTORE} (Y/n) "
read -e -n 1 -r
if [[ ! $REPLY =~ ^[Y]$ ]]; then
  echo 
  echo -e  "${BGYELLOW}                                                                 ${RESTORE}"
  echo -e "${BGLYELLOW}  Installation aborted!                                          ${RESTORE}"
  echo -e  "${BGYELLOW}                                                                 ${RESTORE}"
  echo
  exit 0
fi
echo



# Cleanup contrib modules, themes & libraries from the profile directory.
delete_profile_contrib

# Cleanup the www directory
delete_www_content

# Run the build script (drush make + extra's).
echo -e "${LBLUE}> Run the build script (scripts/build)${RESTORE}"
bash $ROOT/scripts/build
echo

# Install the capacity4more profile
install_drupal_profile

# Setup the files directory
create_sites_default_files_directory

# Enable the development modules
enable_development_modules


# TODO: These commands migrates dummy content and is used for development and
# testing. Comment out both lines if you wish to have a clean capacity4more
# installation.
#drush mi --all --user=1

# This command does the login for you when the build script is done.
# It will open a new tab in your default browser and login to your project as
# the Administrator.
# Comment out this line if you do not want the login to happen automatically.
#drush uli --uri=$BASE_DOMAIN_URL



# Check if we have a working bootstrap
cd $ROOT/www
BOOTSTRAP_SUCCESS=`drush status grep "Drupal bootstrap" | grep "Successful"`
cd $ROOT

if [ ! "$BOOTSTRAP_SUCCESS" ]; then
  echo
  echo -e  "${BGRED}                                                                 ${RESTORE}"
  echo -e "${BGLRED}  Installation failure!                                          ${RESTORE}"
  echo -e  "${BGRED}  > Drupal Bootstrap could not complete successfully             ${RESTORE}"
  echo -e  "${BGRED}                                                                 ${RESTORE}"
  echo
  exit 1
fi



# If we managed to get to here: the installation was successful!

echo
echo -e  "${BGGREEN}                                                                 ${RESTORE}"
echo -e "${BGLGREEN}  Installation complete!                                         ${RESTORE}"
echo -e  "${BGGREEN}  > Visit the site : ${BGLGREEN}capacity4more.dev${BGGREEN}.                          ${RESTORE}"
echo -e  "${BGGREEN}                                                                 ${RESTORE}"
echo

exit 0
