<?php

/**
 * @file
 * Invite new members to a group or project.
 */

/**
 * Implements hook_menu().
 *
 * Defines a path for the page/form used to invite visitors into a group.
 */
function c4m_og_invite_visitors_menu() {
  $items = array();
  $items['group/%node/admin/people/invite-visitors'] = array(
    'title' => 'Invite Visitors',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('_c4m_og_invite_visitors_new_users_form', 1),
    'type' => MENU_LOCAL_TASK,
    'weight' => 4,
    'access callback' => 'c4m_og_invite_visitors_user_access',
    'access arguments' => array(1),
  );

  $items['user/registration/join-group/%node/%'] = array(
    'title' => 'Join Capacity 4 More',
    'type' => MENU_CALLBACK,
    'page callback' => 'c4m_og_invite_visitors_process_acceptance',
    'page arguments' => array(3),
    'access callback' => 'c4m_og_invite_visitors_process_acceptance_access',
    'access arguments' => array(3, 4),
  );

  return $items;
}

/**
 * Checks for missing or empty query string variables.
 *
 * @param array $vars
 *   A list of variable names to check.
 *
 * @return array|bool
 *   Trimmed values array or FALSE if any single variable is missing or empty.
 */
function c4m_og_invite_visitors_validate_query_string(array $vars) {
  $query_vars = array();
  foreach ($vars as $var) {
    if (empty($_GET[$var])) {
      return FALSE;
    }

    $query_vars[] = trim($_GET[$var]);
  }

  return $query_vars;
}

/**
 * Get an invitation object from MySQL by email and group ID.
 *
 * @param string $email
 *   Invitee email address to find.
 * @param int $gid
 *   ID of the group we are checking for.
 *
 * @return bool|object
 *   Invitation object from the DB or FALSE on failure.
 */
function c4m_og_invite_visitors_get_invitation($email, $gid) {
  if (!$email || !$gid) {
    return FALSE;
  }

  $result = db_select('c4m_og_invite_visitors', 'oiv')
    ->fields('oiv', array(
      'inv_group_id',
      'inv_email',
      'inv_created',
      'inv_token',
      'inv_expired',
    ))
    ->condition('inv_group_id', $gid)
    ->condition('inv_email', $email)
    ->range(0, 1)
    ->execute()
    ->fetchObject();

  return $result;
}

/**
 * Validate the accept invitation url before displaying the registration form.
 *
 * Make sure the invitation and the URL itself are legitimate.
 *
 * @param object $group
 *   The group object should be loaded from the acceptance URL.
 */
function c4m_og_invite_visitors_process_acceptance($group) {
  global $user;

  // No group defined. Go to homepage.
  if (!$group) {
    drupal_goto('<front>');
  }

  // Missing qurey string data (email, key or timestamp). Go to group dashboard.
  $query_vars = c4m_og_invite_visitors_validate_query_string(array(
    'email',
    'random-key',
    'timestamp',
  ));
  if (!$query_vars) {
    drupal_goto($group->purl);
  }
  list($email, $random_key, $timestamp) = $query_vars;

  // Validate token and email.
  $invitation = c4m_og_invite_visitors_get_invitation($email, $group->nid);

  // No invitation matches the request. Go to group dashboard.
  if (!$invitation) {
    drupal_goto($group->purl);
  }

  // Data in the invitation does not match the requested data.
  if ($email != $invitation->inv_email || $group->nid != $invitation->inv_group_id || $timestamp != preg_replace('/[^0-9]/', '', $invitation->inv_created)) {
    drupal_goto($group->purl);
  }

  $token = '?email=' . $email . '&random-key=' . $random_key . '&timestamp=' . $timestamp;

  // Validation failed. Go to group dashboard.
  if (!password_verify($token, $invitation->inv_token)) {
    drupal_goto($group->purl);
  }

  // An invitation that had been processed before.
  if ($invitation->inv_expired) {
    drupal_set_message(t('This invitation link has expired.'), 'warning');
    drupal_goto($group->purl);
  }

  // A user is already logged in.
  if ($user->uid) {
    // If the logged in email is the same as the invitation email, add to group.
    // Otherwise, display an error.
    if ($user->mail == $email) {
      // Check if the user is a member already. Add if not.
      if (og_is_member('node', $group->nid, 'user', $user)) {
        drupal_goto($group->purl);
      }
      else {
        // Add the user to the group.
        $values = array(
          'entity_type' => 'user',
          'entity' => $user,
          'state' => OG_STATE_ACTIVE,
        );
        og_group('node', $group, $values);
      }
    }
    else {
      drupal_set_message('Another user is logged in. Please log out and try again.');
      drupal_goto($group->purl);
    }
  }

  // Everything is Kosher, proceed to the registration form.
  // Set group to join in session variable and redirect to /user/register.
  $_SESSION['c4m_og_invite_visitors_gid_join'] = $group->nid;
  drupal_goto('/user/register');
}

/**
 * Implements hook_og_ui_get_group_admin().
 *
 * Adds a menu item (Invite visitors) to the group administration page. Links to
 * the invite visitors form.
 */
function c4m_og_invite_visitors_og_ui_get_group_admin($group_type, $gid) {
  $items = array();
  if (og_user_access($group_type, $gid, 'invite visitors')) {
    $items['c4m_og_invite_visitors'] = array(
      'title' => t('Invite visitors'),
      'description' => t('Create new users and add them as group members.'),
      'href' => 'admin/people/invite-visitors',
    );
  }

  return $items;
}

/**
 * Invite access. Checks if the user is allowed to invite visitors to the group.
 *
 * Checks by user role and og_role against group visibility (Public/Private) and
 * Membership requests setting (Open/Moderated).
 *
 * @param int $gid
 *   The group #ID from the URL.
 *
 * @return bool
 *   Grand/deny access for inviting visitors.
 */
function c4m_og_invite_visitors_user_access($group) {
  // SAs, GOs and GAs can invite new members.
  if (_c4m_features_og_members_is_power_user($group)) {
    return TRUE;
  }

  // OG permission.
  if (!og_user_access('node', $group->nid, 'invite visitors')) {
    return FALSE;
  }

  // Get request type (open/moderated).
  $membership_request_value = c4m_og_get_group_membership_request($group);
  // Get access type (public/private).
  $access_type = c4m_og_get_access_type($group);

  // Non power users are not allowed to invite visitors to a private / moderated
  // group.
  if ($access_type['type'] == 'private' || $membership_request_value == 'moderated') {
    return FALSE;
  }

  return og_is_member('node', $group->nid);
}

/**
 * Implements hook_og_permission().
 *
 * Adds a group permissions to invite visitors to a group.
 */
function c4m_og_invite_visitors_og_permission() {
  $items = array();
  $items['invite visitors'] = array(
    'title' => t('Invite visitors'),
    'description' => t('Users may invite visitors to the group.'),
    'default role' => array(OG_ADMINISTRATOR_ROLE),
  );

  return $items;
}

/**
 * Main OG Invite visitors form.
 *
 * Defines the form structure for inviting visitors to join a group.
 *
 * @param $form
 *   Form object.
 * @param $form_state
 *   Form state object.
 * @param $group
 *   Group object.
 *
 * @return object
 *   Newly created form object.
 *
 */
function _c4m_og_invite_visitors_new_users_form($form, &$form_state, $group) {
  og_set_breadcrumb('node', $group->nid, array(l(t('Group'), "node/" .   $group->nid . "/group")));
  $label = entity_label('node', $group);

  $form['gid'] = array(
    '#type' => 'value',
    '#value' => $group->nid,
  );

  $form['c4m_og_invite_visitors'] = array(
    '#type' => 'fieldset',
    '#title' => t('Invite new users to %group', array('%group' => $label)),
  );
  $form['c4m_og_invite_visitors']['invitee'] = array(
    '#type' => 'textarea',
    '#title' => t('User email(s)'),
    '#description' => t("Use commas or new lines to split email addresses. The new users will be created and invited as members of this group. A one time login link will be sent to the invitees\' email."),
    '#required' => TRUE,
  );
  $form['c4m_og_invite_visitors']['personal_subject'] = array(
    '#type' => 'textfield',
    '#title' => t('Subject'),
    '#description' => t('Add a personal subject to the invitation email.'),
  );
  $form['c4m_og_invite_visitors']['personal_message'] = array(
    '#type' => 'textarea',
    '#title' => t('Add a message (optional)'),
    '#description' => t('Add a personal message to the invitation email.'),
  );

  $form['actions'] = array('#type' => 'actions');
  $form['actions']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Invite user(s)'),
  );

  return $form;
}

/**
 * Validation handler for _c4m_og_invite_visitors_new_users_form.
 *
 * Check the list of emails to invite and filter out invalid entries. File an
 * error for the filtered addresses (if any).
 */
function _c4m_og_invite_visitors_new_users_form_validate($form, &$form_state) {
  // Split the list of email addresses by comma, newline or white space.
  $invitee_emails = preg_split('/\s*[,\n]\s*/', $form_state['values']['invitee']);
  $form_state['invitee_emails'] = array();

  foreach (array_filter($invitee_emails) as $invitee_email) {
    if (!valid_email_address($invitee_email)) {
      form_set_error('invitee', t('Invalid email @email', array('@email' => $invitee_email)));
    }
    else {
      $form_state['invitee_emails'][] = $invitee_email;
    }
  }
}

/**
 * Submit handler for _c4m_og_invite_visitors_new_users_form.
 *
 * Creates a new user for each invited visitor. Creates an OG membership and
 * adds the user to the group.
 */
function _c4m_og_invite_visitors_new_users_form_submit($form, &$form_state) {
  global $user;
  $action = FALSE;
  $gid = $form_state['values']['gid'];
  $invitee_emails = $form_state['invitee_emails'];
  $form_fields = array(
    'subject' => $form_state['values']['personal_subject'],
    'body' => $form_state['values']['personal_message'],
  );
  $entity_type = 'user';

  foreach ($invitee_emails as $invitee_email) {
    // Try to load the user by email and see if exists.
    if ($account = user_load_by_mail($invitee_email)) {
      $account_data = entity_metadata_wrapper('user', $account);
      // Check if account is active.
      if (!$account_data->status->value()) {
        // If blocked user is marked as a spammer, disallow the invitation. No
        // need to check c4m_is_deleted, it's tightly coupled with status.
        if ($account_data->c4m_is_spammer->value()) {
          $message = t('We encountered a problem inviting %address. Please <a href="@contact-page">contact the site administrator</a>.', array(
            '%address' => $invitee_email,
            '@contact-page' => url('contact', array('purl' => array('disabled' => TRUE))),
          ));
        }
        else {
          // Allow the invitation for this inactive user.
          $action = 'invite_user';
        }
      }
      // Check if user is already assigned to the group.
      // Any "state" (active, pending,... counts as existing).
      elseif ($og_membership = og_get_membership('node', $gid, $entity_type, $account->uid)) {
        // Load OG membership.
        $message = t('%user is already a member of this group.', array('%user' => format_username($account)));
      }
      else {
        // Invite existing user.
        $action = 'invite_user';
      }
    }
    else {
      $action = 'invite_visitor';
    }

    switch ($action) {
      case 'invite_visitor':
        $message = c4m_og_invite_visitors_action_invite_visitors($user->uid, $gid, $invitee_email, $form_fields);
        break;

      case 'invite_user':
        // Invoke the invite_user functionality.
        og_invite_invite('node', $gid, OG_AUDIENCE_FIELD, $account->uid);
        $message = t('An email notification was sent to %address.', array('%address' => $invitee_email));
        break;
    }

    // Print the message for each user.
    drupal_set_message($message);
  }
}

function c4m_og_visitors_determine_action() {

}

/**
 * Saves an invitation in the DB and sends a email with the acceptance link.
 *
 * @param int $inviter_uid
 *   User ID of the inviting member.
 * @param int $gid
 *   Group ID.
 * @param string $invitee_email
 *   Invited visitor's email address.
 * @param array $form_fields
 *   Email personal message and subject.
 *
 * @return string
 *   Return a success or error message to use in drupal_set_message().
 */
function c4m_og_invite_visitors_action_invite_visitors($inviter_uid, $gid, $invitee_email, $form_fields) {
  // Saves invitation in the DB and invites the visitor.
  $invitation = c4m_og_invite_visitors_store_invitation($inviter_uid, $gid, $invitee_email);

  // Send the invitation email.
  drupal_mail('c4m_og_invite_visitors', 'invite_group_member', $invitee_email, NULL, array(
    'form_fields' => $form_fields,
    'invitation' => $invitation,
  ), variable_get('site_mail', NULL));

  return $invitation
    ? t('An email notification was sent to %address.', array('%address' => $invitee_email))
    : t('An error occurred inviting %address to the group.', array('%address' => $invitee_email));

}

/**
 * Implements hook_mail().
 *
 * Alters the email sent to visitors when they are invited to join a group. The
 * email subject and body are loaded from template files with the same name as
 * the email identification $key.
 */
function c4m_og_invite_visitors_mail($key, &$message, $params) {
  $language = $message['language'];
  $variables = array(
    'message' => $message,
    'form_fields' => $params['form_fields'],
    'invitation' => $params['invitation'],
  );
  $message['subject'] .= _c4m_og_invite_visitors_mail_text($key . '_subject', $variables);
  $message['body'][] = _c4m_og_invite_visitors_mail_text($key . '_body', $variables);
}

/**
 * Returns a mail string for a variable name.
 *
 * Used by c4m_og_invite_visitors_mail() and the settings forms to retrieve
 * strings.
 *
 * @param string $key
 *   Email identification key.
 * @param array $variables
 *   Data array needed to fill in the tokens in the email template.
 * @param bool $replace
 *   Replace token in the email template.
 *
 * @return string|null
 *   An email string or NULL.
 */
function _c4m_og_invite_visitors_mail_text($key, $variables = array(), $replace = TRUE) {
  global $language;

  // Try to load the text first from variable.
  $text = variable_get($key, FALSE);

  if ($replace) {
    // We do not sanitize the token replacement since we do not output the
    // result to the browser.
    return token_replace($text, $variables, array(
      'language' => $language,
      'callback' => 'c4m_og_invite_visitors_mail_tokens',
      'sanitize' => FALSE,
      'clear' => TRUE,
    )
    );
  }

  return $text;
}

/**
 * Token callback to add unsafe tokens for user mails.
 *
 * This function is used by the token_replace() call at the end of
 * _c4m_og_invite_visitors_mail_text() to set up some additional tokens that can
 * be used in email messages generated by c4m_og_invite_visitors_mail().
 *
 * @param array $replacements
 *   An associative array variable containing mappings from token names to
 *   values (for use with strtr()).
 * @param array $data
 *   An associative array of token replacement values. If the 'user' element
 *   exists, it must contain a user account object with the following
 *   properties:
 *   - login: The UNIX timestamp of the user's last login.
 *   - pass: The hashed account login password.
 * @param array $options
 *   Unused parameter required by the token_replace() function.
 */
function c4m_og_invite_visitors_mail_tokens(&$replacements, $data, $options) {
  global $user, $base_url;

  $group = c4m_og_current_group();
  $url_options = array(
    'absolute' => TRUE,
    'purl' => array(
      'provider' => 'og_purl|node',
      'id' => $group->nid,
    ),
  );
  $replacements['[user:full_name]'] = c4m_user_name($user);
  $replacements['[user:public-profile-url]'] = $base_url . '/users/' . c4m_og_human_to_machine_readable($replacements['[user:full_name]']);
  $replacements['[group:node_type]'] = $group->type;
  $replacements['[group:node_title]'] = $group->title;
  $replacements['[group:accept_invite_url]'] = url('user/registration/joingroup/' . $group->nid . $data['invitation']['token']);
  $replacements['[group:dashboard_url]'] = url('<front>', $url_options);
  $replacements['[personal:subject]'] = $data['form_fields']['subject'];
  $replacements['[personal:body]'] = $data['form_fields']['body'];
  $replacements['[site:name]'] = variable_get('site_name', 'Capacity 4 More');
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Change the submit button value for the invite visitors registration form and
 * add a custom submit handler.
 */
function c4m_og_invite_visitors_form_user_register_form_alter(&$form, &$form_state, $form_id) {
  if (empty($_SESSION['c4m_og_invite_visitors_gid_join'])) {
    return;
  }

  $form['#submit'][] = 'c4m_og_invite_visitors_register_submit';
  $form['actions']['submit']['#value'] = t('Register to join');
}

/**
 * A submit handler for the invite visitors registration.
 *
 * Setting a message to the user and redirect back to the group.
 */
function c4m_og_invite_visitors_register_submit($form, &$form_state) {
  if (!isset($_SESSION['c4m_og_invite_visitors_gid_join']) || !$gid = $_SESSION['c4m_og_invite_visitors_gid_join']) {
    return;
  }

  $group = node_load($gid);
  // Removing the original message of the user_register_form.
  drupal_get_messages('status');
  $message = t('Welcome to group @group_title.', array(
    '@group_title' => $group->title,
  )
  );

  drupal_set_message($message);
  $form_state['redirect'] = drupal_get_path_alias('node/' . $gid);

  // Add the user to the group.
  $values = array(
    'entity_type' => 'user',
    'entity' => $form_state['user'],
    'state' => OG_STATE_ACTIVE,
  );

  og_group('node', $group, $values);

  // Void the invitation token in the database after registration completes and
  // add the new user ID.
  c4m_og_invite_visitors_void_invitation($form_state['user']->uid, $form_state['user']->mail, $gid);

  // drupal_goto has a fallback to the 'destination' so we must remove it.
  unset($_GET['destination']);

  // User is registered, the session variable should be destroyed.
  unset($_SESSION['c4m_og_invite_visitors_gid_join']);
}

/**
 * Invalidate invitation record in the DB.
 *
 * @param int $uid
 *   User ID to add to the invitation record.
 * @param string $email
 *   Invitee email address to find.
 * @param int $gid
 *   ID of the group for which to find an invitation.
 *
 * @return int
 *   Number of invitations set as expired.
 */
function c4m_og_invite_visitors_void_invitation($uid, $email, $gid) {
  // Format date for MySQL datetime field.
  $date = new DateTime();
  $updated = $date->format('Y-m-d H:i:s');

  try {
    $num_updated = db_update('c4m_og_invite_visitors')
      ->fields(array(
        'inv_uid' => $uid,
        'inv_updated' => $updated,
        'inv_expired' => 1,
      ))
      ->condition('inv_email', $email, '=')
      ->condition('inv_group_id', $gid, '=')
      ->execute();
  }
  catch (PDOException $e) {
    watchdog('c4m_og_invite_visitors', $e->getMessage(), NULL, WATCHDOG_ERROR);
  }

  return $num_updated;
}

/**
 * Creates a token hash to safely store in MySQL.
 *
 * The token will be saved with the invitation and used to verify the identity
 * of the accepting user.
 *
 * @param string $email
 *   Invitee email address.
 * @param string $created
 *   Formatted date and time of the request for hashing.
 *
 * @return array
 *   The string token that was hashed and the hash.
 */
function c4m_og_invite_visitors_generate_invitation_hash($email, $created) {
  // Generate a random token.
  $token = '?email=' . $email . '&random-key=' . drupal_random_key() . '&timestamp=' . preg_replace('/[^0-9]/', '', $created);
  return array(
    'hash' => password_hash($token, PASSWORD_DEFAULT),
    'token' => $token,
  );
}

/**
 * Store invitation entry in the DB table c4m_og_invite_visitors.
 *
 * @param int $inviter_id
 *   ID of the inviting user.
 * @param int $group_id
 *   ID of the group for which the invitation is created.
 * @param string $email
 *   Email address of the invitee.
 *
 * @return array|bool
 *   The token that was hashed and stored to validate the invitation and the
 *   invitation ID.
 */
function c4m_og_invite_visitors_store_invitation($inviter_id, $group_id, $email) {
  // Format date for MySQL datetime field.
  $date = new DateTime();
  $created = $date->format('Y-m-d H:i:s');

  $hash = c4m_og_invite_visitors_generate_invitation_hash($email, $created);

  try {
    $invId = db_insert('c4m_og_invite_visitors')
      ->fields(array(
        'inv_inviter_id' => $inviter_id,
        'inv_group_id' => $group_id,
        'inv_email' => $email,
        'inv_created' => $created,
        'inv_token' => $hash['hash'],
      ))
      ->execute();
  }
  catch (PDOException $e) {
    watchdog('c4m_og_invite_visitors', $e->getMessage(), NULL, WATCHDOG_ERROR);
    return FALSE;
  }

  return array(
    'token' => $hash['token'],
    'invId' => $invId,
  );
}
