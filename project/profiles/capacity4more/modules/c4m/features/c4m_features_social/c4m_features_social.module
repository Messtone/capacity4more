<?php

/**
 * @file
 * Code for the social feature.
 */

/**
 * Implements hook_c4m_content_actions_info().
 */
function c4m_features_social_c4m_content_actions_info() {
  return array(
    'social_share' => array(
      'context'   => array('global', 'group'),
      'callback'  => 'c4m_features_social_actions_share',
      'weight'    => '10',
    ),
  );
}

/**
 * Implements hook_block_info().
 */
function c4m_features_social_block_info() {
  $blocks['social_share_links'] = array(
    'info' => t('Social share links'),
    'cache' => DRUPAL_CACHE_PER_PAGE,
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function c4m_features_social_block_view($delta = '') {
  $block = array(
    'subject' => '',
    'content' => c4m_features_social_actions_share(),
  );
}

/**
 * Callback to show the enabled social media.
 *
 * @param object $node
 *    The node object.
 *
 * @return string
 *    Rendered output of the share social media.
 */
function c4m_features_social_actions_share($node = NULL) {
  // Get the social settings.
  $social = variable_get('c4m_social_share', array());
  $social = array_filter($social, 'c4m_features_social_social_enabled');

  $is_printable = isset($social['c4m_print']['enabled']);
  unset($social['c4m_print']);

  $social = array_keys($social);

  $settings = array(
    'service' => 'sbkm',
    'popup' => FALSE,
    'icon' => TRUE,
    'to' => $social,
    'counter' => array('atleast' => 1),
    'selection' => FALSE,
  );
  $data = json_encode($settings);
  $items = '<script type="application/json">' . $data . '</script>';

  if ($is_printable) {
    $items .= '
      <div id="c4m-print">
        <div class="share_list share_style_link share_style_icon_24">
          <a href="#" title="Print" onclick="window.print();return false;"></a>
        </div>
      </div>';
   }

  $output = '<div class="social-actions-share"><h3>' . t('Share this page') . '</h3>' . $items . '</div>';
  drupal_add_js('//europa.eu/webtools/load.js', 'external');
  return $output;
}

/**
 * Callback for array_filter.
 *
 * Check if a social media is enabled.
 *
 * @param array $media
 *    A social media array with settings.
 *
 * @return bool
 *    The status of the social media (TRUE or FALSE).
 */
function c4m_features_social_social_enabled(array $media) {
  return $media['enabled'];
}
