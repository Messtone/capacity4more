<?php
/**
 * @file
 * Code for the Project content type feature.
 */

include_once 'c4m_content_project.features.inc';

/**
 * Implements hook_ctools_plugin_directory().
 */
function c4m_content_project_ctools_plugin_directory($module, $plugin_type) {
  if ($module == 'ctools' && $plugin_type == 'content_types') {
    return 'plugins/' . $plugin_type;
  }
}

/**
 * Implements hook_c4m_og_vocab_info_groups().
 */
function c4m_content_project_c4m_og_vocab_info_groups() {
  return array(
    'project' => array(
      'c4m_vocab_category',
      'c4m_vocab_tag',
    ),
  );
}

/**
 * Implements hook_c4m_content_statistics_info().
 *
 * @todo add c4m_status when it's available in the project content type
 */
function c4m_content_project_c4m_content_statistics_info() {
  return array(
    'global' => array(
      'c4m_projects' => array(
        'type'        => 'project',
        'entity_type' => 'node',
        'bundles'     => array('project'),
        'singular'    => 'Project',
        'plural'      => 'Projects',
        'state'       => 1,
        'aggregate'   => array(),
        'weight'      => -3,
        'attributes'  => array(
          'class' => array('projects'),
        ),
        'link' => array(
          'path' => 'projects',
        ),
      ),
    ),
    'topic' => array(
      'c4m_topic_projects' => array(
        'type'        => 'project',
        'entity_type' => 'node',
        'bundles'     => array('project'),
        'singular'    => 'Project',
        'plural'      => 'Projects',
        'state'       => 1,
        'aggregate'   => array(),
        'weight'      => 1,
        'attributes'  => array(
          'class' => array('topic-projects'),
        ),
        'link' => array(
          'path' => 'projects',
          'options' => array(
            'query' => array(
              'f' => array(
                'c4m_vocab_topic:@TOPIC_ID',
              ),
            ),
          ),
        ),
      ),
    ),
  );
}

/**
 * Implements hook_block_info().
 */
function c4m_content_project_block_info() {
  $blocks = array();

  $blocks['c4m_block_create_project'] = array(
    'info' => t('Project: Create project'),
    'cache' => DRUPAL_NO_CACHE,
  );

  $blocks['c4m_block_project_partners'] = array(
    'info' => t('Project: Partners'),
    'cache' => DRUPAL_NO_CACHE,
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function c4m_content_project_block_view($delta) {
  $module = 'c4m_content_project';

  module_load_include('inc', $module, $module . '.block');
  $callback = "_{$module}_block_" . $delta;
  if (function_exists($callback)) {
    return $callback();
  }

  return array();
}

/**
 * Implements hook_FORM_ID_form_alter().
 *
 * Alter the Project creation form.
 */
function c4m_og_form_project_node_form_alter(&$form, &$form_state) {
  // Form changes on creation.
  if (!$form['nid']['#value']) {
    // Change title.
    drupal_set_title('Request project');

    // Change submit button on creation.
    $form['actions']['submit']['#value'] = t('Request');
  }

  c4m_content_project_set_number_of_items_states($form, 'c4m_left_column');
  c4m_content_project_set_number_of_items_states($form, 'c4m_right_column');
}

/**
 * Helper function to set the correct states for the number of items field.
 *
 * @param array $form
 *   The form on which to act.
 * @param array $element
 *   The form element.
 */
function c4m_content_project_set_number_of_items_states(&$form, $element) {
  foreach ($form[$element][LANGUAGE_NONE] as &$item) {
    if (isset($item['#bundle']) && $item['#bundle'] == 'c4m_paragraph_system_block') {
      $item['c4m_number_of_items']['#states'] = array(
        'visible' => array(
          array(
            ':input[name="' . $element . '[und][' . $item['#delta'] . '][c4m_block][und]"]' => array('value' => 'views:c4m_project_news-block'),
          ),
          array(
            ':input[name="' . $element . '[und][' . $item['#delta'] . '][c4m_block][und]"]' => array('value' => 'views:c4m_project_events-block'),
          ),
        ),
      );
    }
  }
}

/**
 * Returns the administered groups count for an user.
 *
 * @param int $uid
 *   User id.
 *
 * @return int
 *   Count.
 */
function c4m_user_get_administered_projects_count($uid) {
  return c4m_og_get_user_administered_groups_count($uid, 'project');
}

/**
 * Implements hook_c4m_helper_entity_label_info().
 */
function c4m_content_project_c4m_helper_entity_label_info() {
  return array(
    'project' => array(
      'article' => t('a'),
      'singular' => t('project'),
      'plural' => t('projects'),
      'insert action' => t('created a new project'),
      'update action' => t('updated the project'),
      'icon' => 'fa-users',
    ),
  );
}

/**
 * Implements hook_c4m_helper_entity_metrics_info().
 */
function c4m_content_project_c4m_helper_entity_metrics_info() {
  return array(
    'c4m_user_projects_administered' => array(
      'type' => 'projects_administered',
      'context'  => 'user',
      'callback' => 'c4m_user_get_administered_projects_count',
    ),
  );
}

/**
 * Implements hook_field_formatter_info().
 */
function c4m_content_project_field_formatter_info() {
  return array(
    'c4m_partner_formatter' => array(
      'label' => t('C4M Partner'),
      'field types' => array('image'),
      'settings'  => array(),
    ),
  );
}

/**
 * Implements hook_field_formatter_view().
 */
function c4m_content_project_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $element = array();

  foreach ($items as $delta => $item) {
    // Load title and url for the paragraph.
    $title = $entity->c4m_heading[LANGUAGE_NONE][0];
    $url = isset($entity->c4m_link[LANGUAGE_NONE][0]) ? $entity->c4m_link[LANGUAGE_NONE][0] : FALSE;

    // Create image element + link if available.
    $source = theme('image_style', array(
      'style_name' => 'thumbnail',
      'path' => $item['uri'],
      'title' => $title['safe_value'],
    ));

    if ($url) {
      $element[] = array(
        '#markup' => l($source, $url['display_url'], array(
          'html' => TRUE,
          'attributes' => array(
            'target' => $url['attributes']['target'],
          ),
        )),
      );
    }
    else {
      $element[] = array('#markup' => $source);
    }
  }

  return $element;
}

/**
 * Alter referenceable blocks, BEFORE the autocomplete match.
 *
 * @see hook_blockreference_blocks_pre_alter()
 */
function c4m_content_project_blockreference_blocks_pre_alter(&$blocks, $context) {
  $whitelist = module_invoke_all('c4m_content_project_blockreference_whitelist');

  // Remove blocks which are not whitelisted.
  foreach ($blocks as $id => $block) {
    $block_string = $block->module . ':' . $block->delta;
    if (!in_array($block_string, $whitelist) && !array_key_exists($block_string, $whitelist)) {
      unset($blocks[$id]);
    }
    else {
      if (array_key_exists($block_string, $whitelist)) {
        $block->info = $whitelist[$block_string]['label'];
      }
    }
  }
}

/**
 * Implements hook_pc_system_component_blockreference_whitelist().
 */
function c4m_content_project_c4m_content_project_blockreference_whitelist() {
  return array(
    'c4m_content_project:c4m_block_project_partners' => array(
      'label' => t('Project partners'),
    ),
    'views:c4m_project_news-block' => array(
      'label' => t('Project news'),
    ),
    'views:c4m_project_events-block' => array(
      'label' => t('Project events'),
    ),
  );
}

/**
 * Implements hook_ds_fields_info().
 */
function c4m_content_project_ds_fields_info($entity_type) {
  // Special field to render the block reference according to type of block.
  $fields = array(
    'c4m_system_block_renderer' => array(
      'title' => t('C4M System Block Renderer'),
      'field_type' => DS_FIELD_TYPE_FUNCTION,
      'ui_limit' => array(),
      'function' => 'c4m_content_project_system_block_renderer',
    ),
  );
  return array($entity_type => $fields);
}

/**
 * Callback for the system block renderer field.
 *
 * @param string $field
 *   The field which to render.
 *
 * @return array
 *   Rendered output.
 */
function c4m_content_project_system_block_renderer($field) {
  if ($paragraph_id = $field['entity']->item_id) {
    if ($paragraphs_item = paragraphs_item_load_multiple(array($paragraph_id))) {
      $paragraphs_item = reset($paragraphs_item);
      $block_info = explode(':', $paragraphs_item->c4m_block[LANGUAGE_NONE][0]['moddelta']);

      // If the referenced block is NOT a View.
      if ($block_info[0] != 'views') {
        // Simply render the block.
        $rendered_block = c4m_content_project_render_block($block_info[0], $block_info[1]);
        return render($rendered_block);
      }

      // If a View, take into account the number of items parameter.
      $number_of_items = isset($paragraphs_item->c4m_number_of_items) ? $paragraphs_item->c4m_number_of_items : 5;

      // Get info for the View.
      $views_info = explode('-', $block_info[1]);
      $view = views_get_view($views_info[0]);

      // Set number of items.
      $number_of_items = $number_of_items[LANGUAGE_NONE][0]['value'];
      $view->set_items_per_page($number_of_items);

      // Render the View.
      $output = $view->preview($views_info[1], array());
      $view->destroy();

      return $output;
    }
  }

  return '';
};

/**
 * Returns the render-able array for a block.
 *
 * @param string $module
 *   The block's module.
 * @param string $delta
 *   The block's delta.
 *
 * @return array
 *   Renderable array.
 */
function c4m_content_project_render_block($module, $delta) {
  $block = block_load($module, $delta);
  $render_array = _block_get_renderable_array(_block_render_blocks(array($block)));
  return $render_array;
}
