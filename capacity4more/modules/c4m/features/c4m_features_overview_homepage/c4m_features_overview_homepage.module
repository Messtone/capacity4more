<?php
/**
 * @file
 * Code for the Homepage feature.
 */

include_once 'c4m_features_overview_homepage.features.inc';


/**
 * Implements hook_preprocess_html().
 *
 * Add settings to the Angular application.
 */
function c4m_features_overview_homepage_preprocess_html() {
  global $user;

  if (!drupal_is_front_page()) {
    return;
  }

  $groups = $user->uid ? og_get_groups_by_user($user) : c4m_og_get_groups_by_access_type('public');

  $activity_stream_handler = restful_get_restful_handler('activity_stream');

  $request = array(
    'filter' => array(
      'group' => array(
        'value' => isset($groups['node']) ? $groups['node'] : $groups,
        'operator' => 'IN'
      ),
    ),
    'html' => true,
    // Sort the activity stream by timestamp descending.
    'sort' => '-timestamp',
  );

  $activities = $activity_stream_handler->get('', $request);

  // URL options.
  $options = array(
    'purl' => array(
      'disabled' => TRUE,
    ),
    'absolute' => TRUE,
  );

  // Pass info via Drupal.settings.
  $settings['c4m'] = array(
    'basePath' => url('', $options),
    'csrfToken' => drupal_get_token(\RestfulInterface::TOKEN_VALUE),
    'activities' => $activities,
    'data' => array(
      'entity' => array('group' => isset($groups['node']) ? $groups['node'] : $groups),
    ),
  );
  drupal_add_js($settings, 'setting');

}
