<?php

/**
 * Implements hook_field_widget_info_alter().
 *
 * Alter the module that handles our widget to add ckeditor to the body field.
 */
function c4m_body_widget_field_widget_info_alter(&$info) {
  $info['text_textarea_with_summary']['module'] = 'c4m_body_widget';
}

/**
 * Implements hook_field_widget_form().
 */
function c4m_body_widget_field_widget_form(&$form, &$form_state, $field, $instance, $langcode, $items, $delta, $element) {
  $entity = isset($element['#entity']) ? $element['#entity'] : NULL;

  if (!$entity) {
    return;
  }

  // Send the field value to the app if the current page is the edit page.
  if (isset($entity->c4m_body) && $entity->c4m_body) {
    $value = $entity->c4m_body[$langcode][0]['value'];
    $settings['c4m']['data']['body'] = $value;

    // Send all the settings to the app.
    $form['#attached']['js'][] = array(
      'data' => $settings,
      'type' => 'setting'
    );
  }

  // Add controller.
  $form['#attributes']['ng-controller'] = 'DrupalFormCtrl';
  $form['#attributes']['class'][] = 'drupal-form';

  $element = text_field_widget_form($form, $form_state, $field, $instance, $langcode, $items, $delta, $element);

  // Add attributes to the existing element, This will load the ngCkeditor.
  $element['#attributes']['ckeditor'] = 'editorOptions';
  $element['#attributes']['ng-model'] = 'data.body';
  return $element;
}
